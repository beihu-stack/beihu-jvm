## 即时编译

Java代码先被Java虚拟机解析执行，之后反复执行的**热点代码**则会被即时编译成为**机器码**，直接运行在底层硬件上



##### 分层编译模式：

HotSpot虚拟机即时编译器：C1、C2、Graal（实验性质的即时编译器）

通过 -XX:+UnlockExperimentalVMOptions -XX:+UseJVMCICompiler 启用，并且替换 C2

- Java7之前：（需要根据程序的特性选择对应的即时编译器）
  - 执行时间较短的，或者对启动性能有要求的程序，采用编译效率较快的C1
    - JVM参数：-client
  - 执行时间较长的，或者对峰值性能有要求的程序，采用生成代码执行效率较快的C2
    - JVM参数：-server
- Java7：（分层编译：JVM参数： -XX:+TieredCompilation）
  - 综合C1的启动性能优势和C2的峰值性能优势
  - JVM执行状态分为5层
    - 1. 解释执行
      2. 执行不带profiling的C1生成的机器码
      3. 执行仅带方法调用次数以及循环回边执行次数profiling的C1机器码
      4. 执行带所有profilling的C1机器码
      5. 执行C2机器码
  - 通常情况下：C2的机器码执行效率比C1的机器码高出30%
  - profiling：程序执行过程中，收集能够反映程序执行状态的数据，这些被收集的数据我们称为程序的profile
  - Java8默认开启分层编译
    - **不管是开启还是关闭分层编译，-client和-server参数都是无效的**
    - 当关闭分层编译的情况下，虚拟机默认采用C2
    - 如果你希望只有C1：打开分层编译的情况下，JVM参数：-XX:TieredStopAtLevel=1



##### 即时编译的触发：

JVM根据方法的调用次数以及循环回边的执行次数来触发即时编译

- 不开启分层时：
  - 当方法的调用次数和循环回边的次数和，超过由参数 -XX:CompileThreshold指定的阈值时（C1：1500；C2：10000），便会触发即时编译
- 开启分层时：
  - 参数-XX:CompileThreshold失效；采用**动态阈值**
  - 有一个计算公式